function e(e,t,i,o){return new(i||(i=Promise))((function(s,n){function c(e){try{a(o.next(e))}catch(e){n(e)}}function r(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(c,r)}a((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;function t(t,i,o){return e(this,void 0,void 0,(function*(){const e={streamurl:i,sdp:o.sdp},s=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return yield s.json()}))}class i{constructor(){this.pc=new RTCPeerConnection,this.stream=new MediaStream,this.pc.ontrack=e=>{this.stream.addTrack(e.track)}}play(i){return e(this,void 0,void 0,(function*(){if(i.includes("localhost")||i.includes("127.0.0.1"))throw"向 127.0.0.1 或 localhost 请求视频流无效";this.pc.addTransceiver("audio",{direction:"recvonly"}),this.pc.addTransceiver("video",{direction:"recvonly"});const e=yield this.pc.createOffer();yield this.pc.setLocalDescription(e);let o="";if(i.includes("?")){const e=i.indexOf("?");o=i.slice(e)}const s=`/rtc/v1/play/${o}`;try{const o=yield t(s,i,e);return yield this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:o.sdp})),!0}catch(e){throw"拉流失败"}}))}close(){this.pc&&this.pc.close()}}class o{constructor(){this.pc=new RTCPeerConnection,this.stream=new MediaStream}publish(i){return e(this,void 0,void 0,(function*(){if(s.noMediaDevices.validator())throw s.noMediaDevices.message;if(s.notAllowedURL.validator())throw s.notAllowedURL.message;let e;this.pc.addTransceiver("audio",{direction:"sendonly"}),this.pc.addTransceiver("video",{direction:"sendonly"});try{e=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){console.error(s.noMediaDevices.message)}null==e||e.getTracks().forEach((e=>{this.pc.addTrack(e),this.stream.addTrack(e)}));const o=yield this.pc.createOffer();yield this.pc.setLocalDescription(o);try{const e=yield t("/rtc/v1/publish/",i,o);return yield this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e.sdp})),!0}catch(e){throw"推流失败"}}))}close(){this.pc&&this.pc.close()}}const s={noMediaDevices:{validator:()=>!navigator.mediaDevices,message:"请连接麦克风"},notAllowedURL:{validator:()=>"http:"===window.location.protocol&&"localhost"!==window.location.hostname,message:"不允许协议为非https"}};export{i as SrsRtcPlayerAsync,o as SrsRtcPublisherAsync};
