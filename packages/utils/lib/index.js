function e(e,t,i,s){return new(i||(i=Promise))((function(o,n){function c(e){try{a(s.next(e))}catch(e){n(e)}}function r(e){try{a(s.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(c,r)}a((s=s.apply(e,t||[])).next())}))}function t(t,i,s){return e(this,void 0,void 0,(function*(){const e={streamurl:i,sdp:s.sdp},o=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return yield o.json()}))}"function"==typeof SuppressedError&&SuppressedError;class i{constructor(){this.pc=new RTCPeerConnection,this.stream=new MediaStream,this.pc.ontrack=e=>{this.stream.addTrack(e.track)}}play(i){return e(this,void 0,void 0,(function*(){if(i.includes("localhost")||i.includes("127.0.0.1"))throw"向 127.0.0.1 或 localhost 请求视频流无效";this.pc.addTransceiver("audio",{direction:"recvonly"}),this.pc.addTransceiver("video",{direction:"recvonly"});const e=yield this.pc.createOffer();yield this.pc.setLocalDescription(e);let s="";if(i.includes("?")){const e=i.indexOf("?");s=i.slice(e)}const o=`/rtc/v1/play/${s}`;try{const s=yield t(o,i,e);return yield this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:s.sdp})),!0}catch(e){throw"拉流失败"}}))}close(){this.pc&&this.pc.close()}}class s{constructor(e={audio:!0,video:!0}){this.pc=new RTCPeerConnection,this.stream=new MediaStream,this.constraints=e}publish(i){return e(this,void 0,void 0,(function*(){if(o.noMediaDevices.validator())throw o.noMediaDevices.message;if(o.notAllowedURL.validator())throw o.notAllowedURL.message;let e;this.pc.addTransceiver("audio",{direction:"sendonly"}),this.pc.addTransceiver("video",{direction:"sendonly"});try{e=yield navigator.mediaDevices.getUserMedia(this.constraints)}catch(e){console.error(o.noMediaDevices.message)}null==e||e.getTracks().forEach((e=>{this.pc.addTrack(e),this.stream.addTrack(e)}));const s=yield this.pc.createOffer();yield this.pc.setLocalDescription(s);try{const e=yield t("/rtc/v1/publish/",i,s);return yield this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e.sdp})),!0}catch(e){throw"推流失败"}}))}close(){this.pc&&this.pc.close()}}const o={noMediaDevices:{validator:()=>!navigator.mediaDevices,message:"请连接麦克风"},notAllowedURL:{validator:()=>"http:"===window.location.protocol&&"localhost"!==window.location.hostname,message:"不允许协议为非https"}};export{i as SrsRtcPlayerAsync,s as SrsRtcPublisherAsync};
